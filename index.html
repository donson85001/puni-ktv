<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å™—å¦®æ­Œå–®</title>

<style>
  body{ margin:0; background:#111; color:#fff; font-family: Arial, "Noto Sans TC", sans-serif; }
  a{ color:#ff69b4; text-decoration:none; }
  a:hover{ text-decoration:underline; }

  .hero{ position:relative; height:260px; overflow:hidden; border-bottom:2px solid #222; }
  .hero img.bg{
    width:100%; height:100%; object-fit:cover; display:block;
    opacity:.5; filter: brightness(.9);
  }

  .topbar{
    position:absolute; top:14px; left:14px; right:14px;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
  }
  .brand{ display:flex; align-items:center; gap:12px; }
  .brand img{
    width:56px; height:56px; border-radius:12px; object-fit:cover;
    border:2px solid rgba(255,105,180,0.6); background:#222;
  }
  .brand .title{
    font-size:28px; font-weight:900; letter-spacing:1px;
    text-shadow:0 2px 10px rgba(0,0,0,0.6);
  }

  .nav{ display:flex; gap:10px; flex-wrap:wrap; }

  .container{ width:min(1100px, 92%); margin:18px auto; }

  .toolbar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:14px 0; }

  input[type="text"], input[type="number"], input[type="password"], select{
    background:#1b1b1b; border:1px solid #333; color:#fff;
    padding:10px 12px; border-radius:10px; outline:none;
  }

  .btn{
    background:#ff69b4; color:#fff; border:none;
    padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:900;
  }
  .btn.gray{ background:#2a2a2a; }
  .btn:disabled{ opacity:.5; cursor:not-allowed; }

  /* âœ… åˆ†é¡æŒ‰éˆ•ï¼šæœªé¸ç¶­æŒåŸæœ¬ï¼›hover ç²‰æ¡†é»‘åº•ç™½å­—ï¼›é¸ä¸­ç²‰åº•ç™½å­— */
.tab-btn{
  background:#2a2a2a;
  color:#fff;
  border:1px solid transparent;
  padding:10px 12px;
  border-radius:10px;
  cursor:pointer;
  font-weight:900;
}
.tab-btn:hover{
  background:#111;
  color:#fff;
  border-color:#ff69b4;
}
.tab-btn.active{
  background:#ff69b4;
  color:#fff;
  border-color:#ff69b4;
}

  .song-card{
    background:#1e1e1e; border-radius:14px;
    padding:14px; margin:10px 0;
    display:flex; justify-content:space-between; align-items:center;
    border-left:7px solid #ff69b4; min-height:78px;
  }
  .song-left{ display:flex; flex-direction:column; gap:6px; }
  .song-name{ font-size:18px; font-weight:900; letter-spacing:.5px; }
  .song-meta{ opacity:.85; font-size:13px; }
  .star{ color:gold; font-weight:900; margin-left:6px; }

 /* ===== æ­Œæ‰‹å°åˆ†é¡ï¼šhover é»‘åº•ç²‰æ¡†ç™½å­—ï¼›active ç²‰åº•ç™½å­— ===== */
.chip{
  display:inline-block;
  background:#2a2a2a;
  color:#fff;
  padding:6px 10px;
  border-radius:999px;
  margin:4px 6px 0 0;
  cursor:pointer;
  border:1px solid transparent;
  font-weight:900;
}
.chip:hover{
  background:#111;
  color:#fff;
  border-color:#ff69b4;
}
.chip.active{
  background:#ff69b4;
  color:#fff;
  border-color:#ff69b4;
}

  .pagination{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin:16px 0 24px; }

  .page{ display:none; }
  .page.active{ display:block; }

  .login-box{
    background:#1b1b1b; border:1px solid #333; border-radius:14px;
    padding:14px; display:none; margin:10px 0;
  }

  .modal-overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.55);
    display:none; align-items:center; justify-content:center; padding:16px;
  }
  .modal{
    width:min(560px, 96%);
    background:#141414; border:1px solid #333; border-radius:16px;
    padding:16px;
  }
  .modal h3{ margin:0 0 10px; font-size:18px; font-weight:900; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0; }
  label{ display:block; font-size:13px; opacity:.9; margin-bottom:6px; font-weight:900; }
  .field{ flex:1; min-width:220px; }
  .hint{ opacity:.8; font-size:13px; }

  /* âœ… å­æ¨™ç±¤è¼¸å…¥å€æ‹‰é•·é¿å…è¢«åƒå­—ï¼ˆç›®å‰æ”¹æˆä¸‹æ‹‰ï¼Œé€™æ®µä¿ç•™ä¹Ÿä¸å½±éŸ¿ï¼‰ */
  textarea.big{
    width:100%;
    min-height:88px;
    resize:vertical;
    background:#1b1b1b;
    border:1px solid #333;
    color:#fff;
    padding:10px 12px;
    border-radius:10px;
    outline:none;
    line-height:1.4;
    font-size:14px;
  }

  .home-block{
    background:#1b1b1b; border:1px solid #333; border-radius:16px;
    padding:16px; margin:14px 0; line-height:1.8;
  }
  .home-block h2{ margin:0 0 10px; font-size:18px; font-weight:900; }

  /* âœ… é¦–é ğŸ¦­ï¼šæ›´å¤§ã€ç½®ä¸­ã€é é¢æœ€ä¸‹æ–¹ã€ä¸åœ¨æ ¼å­å…§ */
  .seal-bottom{
    text-align:center;
    font-size:92px; /* â† è®Šæ›´ï¼šæ›´å¤§ */
    margin:18px 0 56px;
  }
/* ===== ä¸Šæ–¹å°è¦½ï¼šhover é»‘åº•ç²‰æ¡†ç™½å­—ï¼›active ç²‰åº•ç™½å­— ===== */
/* ===== ä¸Šæ–¹å°è¦½æŒ‰éˆ• ===== */
.nav-tab{
  background: transparent;
  color:#fff;
  border:1px solid #fff;
  padding:8px 14px;
  border-radius:10px;
  cursor:pointer;
  font-weight:900;
  transition: all .2s ease;
}
.nav-tab:hover{
  background:#111;
  border-color:#ff69b4;
  color:#fff;
}
.nav-tab.active{
  background:#ff69b4;
  border-color:#ff69b4;
  color:#fff;
}

.nav-admin{
  background: rgba(255,105,180,0.92);
  color:#fff;
  border:none;
  padding:8px 12px;
  border-radius:10px;
  cursor:pointer;
  font-weight:900;
}</style>
</head>

<body>

<div class="hero">
  <img class="bg" src="bg.jpg" alt="top-bg" />

  <div class="topbar">
    <div class="brand">
      <img src="cute.gif" alt="cute-gif" />
      <div class="title">å™—å¦®æ­Œå–®</div>
    </div>

<div class="nav">
  <button id="nav-home" class="nav-tab" onclick="goPage('home')">é¦–é </button>
  <button id="nav-songs" class="nav-tab" onclick="goPage('songs')">é»æ­Œ</button>
  <button id="nav-ranking" class="nav-tab" onclick="goPage('ranking')">æ’è¡Œæ¦œ</button>
  <button class="nav-admin" onclick="toggleLogin()">ç®¡ç†è€…</button>
</div>
  </div>
</div>

<div class="container">

  <div class="login-box" id="loginBox">
    <div class="toolbar" style="margin:0;">
      <input type="text" id="username" placeholder="å¸³è™Ÿ" />
      <input type="password" id="password" placeholder="å¯†ç¢¼" />
      <button class="btn" onclick="login()">ç™»å…¥</button>
      <button class="btn gray" id="logoutBtn" onclick="logout()" style="display:none;">ç™»å‡º</button>
      <span id="loginStatus" class="hint"></span>
    </div>
  </div>

  <div class="page active" id="page-home">
    <div class="home-block">
      <h2>æ„Ÿè¬å„ä½æ”¯æŒ~</h2>
      <div>å¤§å®¶æœ‰å¸Œæœ›å¯ä»¥è½åˆ°çš„æ­Œ ä¹Ÿå¯ä»¥æŠ•å…¥è¨±é¡˜æ± ä¸­</div>
      <div style="margin-top:8px;">
        <a href="https://docs.google.com/forms/d/1zg8hLVJbUtwhl8CI2ItqcC_GoTshKo49zmcHYimVfjo/edit" target="_blank" rel="noopener">
          è¨±é¡˜æ± ï¼ˆé»æˆ‘ï¼‰
        </a>
      </div>
    </div>

    <div class="home-block">
      <h2>å–œæ­¡çš„è©±ä¹Ÿå¯ä»¥çµ¦ä¸€é»é»æ‰“è³é‡‘</h2>
      <div style="margin-top:8px;">
        <a href="https://donation-goal.hikarunogo.com.tw/Donate/Opay/3B4116F0A4064BB35254CDF1B9ED84E9" target="_blank" rel="noopener">
          æ‰“è³ï¼ˆé»æˆ‘ï¼‰
        </a>
      </div>
      <div style="margin-top:10px;">å†æ¬¡æ„Ÿè¬å„ä½æ”¯æŒ~</div>
    </div>

    <div class="seal-bottom">ğŸ¦­</div>
  </div>

  <div class="page" id="page-songs">
    <div class="toolbar">
      <input type="text" id="search" placeholder="æœå°‹æ­Œåæˆ–æ­Œæ‰‹" />

      <!-- âœ… åˆ†é¡æŒ‰éˆ•ï¼šactive æ¨£å¼ç”± JS æ§åˆ¶ -->
      <button id="btn-female" class="tab-btn" onclick="setCategory('å¥³æ­Œæ‰‹')">å¥³æ­Œæ‰‹</button>
      <button id="btn-male" class="tab-btn" onclick="setCategory('ç”·æ­Œæ‰‹')">ç”·æ­Œæ‰‹</button>
      <button id="btn-other" class="tab-btn" onclick="setCategory('å…¶ä»–')">å…¶ä»–</button>
      <button id="btn-all" class="tab-btn" onclick="setCategory('å…¨éƒ¨')">å…¨éƒ¨</button>

      <!-- âœ… åªæœ‰ç®¡ç†è€…ç™»å…¥æ‰æœƒçœ‹åˆ°ï¼šæ–°å¢æ­Œæ›² -->
      <button id="btn-adminAdd" class="btn" style="display:none;" onclick="openAdminAddSong()">æ–°å¢æ­Œæ›²</button>
    </div>

    <div id="singerBar"></div>
<div id="otherSubBar"></div>

    <div id="songList"></div>
    <div class="pagination" id="pagination"></div>
  </div>

  <div class="page" id="page-ranking">
    <div class="toolbar">
      <div class="hint">æ’è¡Œæ¦œï¼šå‰ 40 åï¼ˆæ¯é  10 é¦–ï¼‰</div>
    </div>
    <div id="rankList"></div>
    <div class="pagination" id="rankPagination"></div>
  </div>

</div>

<!-- âœ… æ–°å¢æ­Œæ›² Modalï¼šæ”¹æˆä¸‹æ‹‰é¸å–® -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h3>æ–°å¢æ­Œæ›²</h3>
    <div class="hint" id="addSongTarget">ï¼ˆç®¡ç†è€…ï¼‰æ–°å¢åˆ°è©¦ç®—è¡¨</div>

    <div class="row">
      <div class="field">
        <label>åˆ†é¡ï¼ˆå·¥ä½œè¡¨ï¼‰</label>
        <select id="mSheet" onchange="onSheetChange()">
          <option value="å¥³æ­Œæ‰‹">å¥³æ­Œæ‰‹</option>
          <option value="ç”·æ­Œæ‰‹">ç”·æ­Œæ‰‹</option>
          <option value="å…¶ä»–">å…¶ä»–</option>
        </select>
      </div>

      <div class="field" id="subtagSelectField" style="display:none;">
        <label>å…¶ä»–å­æ¨™ç±¤</label>
        <select id="mSubtagSelect">
          <option value="æ—¥">æ—¥</option>
          <option value="éŸ“">éŸ“</option>
          <option value="è‹±">è‹±</option>
          <option value="Rap">Rap</option>
          <option value="æƒ…æ­Œå°å”±">æƒ…æ­Œå°å”±</option>
          <option value="å—¨æ­Œ/æ€ªæ­Œ">å—¨æ­Œ/æ€ªæ­Œ</option>
          <option value="èˆè¹ˆ">èˆè¹ˆ</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>æ­Œå</label>
        <input type="text" id="mSongName" />
      </div>
      <div class="field">
        <label>æ­Œæ‰‹</label>
        <input type="text" id="mSinger" />
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>ä¸ç†Ÿæ¨™è¨˜</label>
        <button class="btn gray" id="starToggleBtn" onclick="toggleStar()">â˜† æœªæ¨™è¨˜</button>
        <div class="hint">æŒ‰ä¸€ä¸‹è®Š â˜…ï¼Œå†æŒ‰ä¸€ä¸‹å–æ¶ˆ</div>
      </div>

      <div class="field">
        <label>æ’­æ”¾æ¬¡æ•¸</label>
        <input type="number" id="mPlays" value="0" min="0" />
      </div>
    </div>

    <div class="row" style="justify-content:flex-end;">
      <button class="btn gray" onclick="closeAddSong()">å–æ¶ˆ</button>
      <button class="btn" onclick="submitAdminAddSong()">é€å‡ºæ–°å¢</button>
    </div>
  </div>
</div>

<script>
function renderOtherSubBar(){
  const bar = document.getElementById("otherSubBar");
  bar.innerHTML = "";

  if(category !== "å…¶ä»–"){
    selectedSubtag = null;
    return;
  }

  OTHER_SUBTAGS.forEach(tag=>{
    const chip = document.createElement("span");
    chip.className = "chip" + (tag===selectedSubtag ? " active" : "");
    chip.textContent = tag;

    chip.onclick = ()=>{
      selectedSubtag = (selectedSubtag===tag ? null : tag);
      listPage = 1;
      renderSongsPage();
    };

    bar.appendChild(chip);
  });
}
  const apiUrl = "https://script.google.com/macros/s/AKfycbz9bbIGWFaXipJu08IAY5yKSy9tXCiU2qLB8-e1kVVEkfMxvhtQIECZmf1Qpvwni_tj/exec";
const OTHER_SUBTAGS = ["æ—¥","éŸ“","è‹±","Rap","æƒ…æ­Œå°å”±","å—¨æ­Œ/æ€ªæ­Œ","èˆè¹ˆ"];
let selectedSubtag = null;
  let allSongs = [];
  let token = localStorage.getItem("ktv_token") || null;

  let category = "å…¨éƒ¨";
  let selectedSinger = null;

  let listPage = 1;
  const pageSize = 10;

  let rankPage = 1;

  // modal state
  let starSelected = false;

  initLoginUI();
  loadAllSongs().then(() => { applyCategoryButtonState(); renderSongsPage(); renderRankingPage(); });
document.getElementById("nav-home").classList.add("active");

  function initLoginUI(){
    if(token){
      logoutBtn.style.display="inline-block";
      loginStatus.textContent="å·²ç™»å…¥ï¼ˆä¸æœƒè‡ªå‹•ç™»å‡ºï¼ŒæŒ‰ç™»å‡ºæ‰æœƒç™»å‡ºï¼‰";
      document.getElementById("btn-adminAdd").style.display = "inline-block";
    }else{
      logoutBtn.style.display="none";
      loginStatus.textContent="";
      document.getElementById("btn-adminAdd").style.display = "none";
    }
  }

  function toggleLogin(){
    loginBox.style.display = (loginBox.style.display==="block") ? "none" : "block";
  }

  function postJSON(payload){
    return fetch(apiUrl, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    }).then(r => r.json());
  }

  function login(){
    postJSON({
      action:"login",
      username: username.value,
      password: password.value
    })
    .then(res=>{
      if(res.status==="success"){
        token=res.token;
        localStorage.setItem("ktv_token", token);
        initLoginUI();
        loginBox.style.display="none";
        renderSongsPage();
        renderRankingPage();
      }else{
        alert("å¸³è™Ÿå¯†ç¢¼éŒ¯èª¤");
      }
    })
    .catch(()=>alert("ç™»å…¥å¤±æ•—ï¼šè«‹ç¢ºèª /exec èˆ‡éƒ¨ç½²æ¬Šé™"));
  }

  function logout(){
    localStorage.removeItem("ktv_token");
    token=null;
    initLoginUI();
    renderSongsPage();
    renderRankingPage();
  }

  async function loadAllSongs(){
    const res = await fetch(apiUrl);
    allSongs = await res.json();
  }

function goPage(name){

  // åˆ‡æ›é é¢
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.getElementById("page-"+name).classList.add("active");

  // æ¸…é™¤æ‰€æœ‰å°è¦½ active
  document.querySelectorAll(".nav-tab").forEach(btn=>{
    btn.classList.remove("active");
  });

  // è¨­å®šç›®å‰é é¢ active
  const map = {
    home:"nav-home",
    songs:"nav-songs",
    ranking:"nav-ranking"
  };

  if(map[name]){
    document.getElementById(map[name]).classList.add("active");
  }

  if(name==="songs") renderSongsPage();
  if(name==="ranking") renderRankingPage();
}

  function applyCategoryButtonState(){
    const map = {
      "å¥³æ­Œæ‰‹": "btn-female",
      "ç”·æ­Œæ‰‹": "btn-male",
      "å…¶ä»–": "btn-other",
      "å…¨éƒ¨": "btn-all"
    };
    Object.values(map).forEach(id => document.getElementById(id).classList.remove("active"));
    const id = map[category];
    if(id) document.getElementById(id).classList.add("active");
  }

  function setCategory(c){
    category=c;
    selectedSinger=null;
    listPage=1;
    applyCategoryButtonState();
    renderSongsPage();
  }

  search.addEventListener("input", ()=>{ listPage=1; renderSongsPage(); });

  function renderSingerBar(){
    singerBar.innerHTML="";
    if(category==="å…¨éƒ¨"){
      singerBar.innerHTML = `<div class="hint">é¸å¥³æ­Œæ‰‹/ç”·æ­Œæ‰‹/å…¶ä»–å¾Œï¼Œé€™è£¡æœƒå‡ºç¾æ­Œæ‰‹åå–®</div>`;
      return;
    }

    const singers=[...new Set(
      allSongs.filter(s=>s.sheetName===category).map(s=>s["æ­Œæ‰‹"]).filter(Boolean)
    )].sort((a,b)=>String(a).localeCompare(String(b),"zh-Hant"));

    singers.forEach(name=>{
      const chip=document.createElement("span");
      chip.className="chip"+(name===selectedSinger?" active":"");
      chip.textContent=name;
      chip.onclick=()=>{
        selectedSinger = (selectedSinger===name)?null:name;
        listPage=1;
        renderSongsPage();
      };
      singerBar.appendChild(chip);
    });

    if(singers.length===0){
      singerBar.innerHTML = `<div class="hint">é€™å€‹åˆ†é¡ç›®å‰æ²’æœ‰è³‡æ–™</div>`;
    }
  }

function getFilteredSongs(){
  const q=(search.value||"").trim();
  let data=[...allSongs];

  if(category!=="å…¨éƒ¨") data=data.filter(s=>s.sheetName===category);
  if(selectedSinger) data=data.filter(s=>(s["æ­Œæ‰‹"]||"")===selectedSinger);

  // âœ… åªæœ‰ã€Œå…¶ä»–ã€æ‰å¥—ç”¨å­åˆ†é¡ç¯©é¸
  if(category==="å…¶ä»–" && selectedSubtag){
    data = data.filter(s => String(s["å­æ¨™ç±¤"]||"").includes(selectedSubtag));
  }

  if(q){
    data=data.filter(s=>String(s["æ­Œå"]||"").includes(q) || String(s["æ­Œæ‰‹"]||"").includes(q));
  }
  return data;
}

  function renderSongsPage(){
    renderSingerBar();
renderOtherSubBar();

    const data=getFilteredSongs();
    const totalPages=Math.max(1, Math.ceil(data.length/pageSize));
    if(listPage>totalPages) listPage=1;

    const start=(listPage-1)*pageSize;
    const pageData=data.slice(start, start+pageSize);

    songList.innerHTML="";
    pageData.forEach(song=>{
      const card=document.createElement("div");
      card.className="song-card";

      const star = (song["æ˜Ÿè™Ÿ"]==="â˜…") ? `<span class="star">â˜…</span>` : "";
      const plays = Number(song["æ’­æ”¾æ¬¡æ•¸"]||0);

      card.innerHTML=`
        <div class="song-left">
          <div class="song-name">${esc(song["æ­Œå"]||"")} - ${esc(song["æ­Œæ‰‹"]||"")} ${star}</div>
          <div class="song-meta">
            åˆ†é¡ï¼š${song.sheetName}
            ${song.sheetName==="å…¶ä»–" && song["å­æ¨™ç±¤"] ? "ï½œ å­æ¨™ç±¤ï¼š"+esc(song["å­æ¨™ç±¤"]) : ""}
            ï½œ æ’­æ”¾æ¬¡æ•¸ï¼š<span id="plays-${song.sheetName}-${song.rowIndex}">${plays}</span>
          </div>
        </div>
        <div>
          ${token ? `<button class="btn" onclick="addClick('${song.sheetName}',${song.rowIndex})">+1</button>`:""}
        </div>
      `;
      songList.appendChild(card);
    });

    pagination.innerHTML="";
    for(let i=1;i<=totalPages;i++){
      const b=document.createElement("button");
      b.className="btn gray";
      b.textContent=i;
      b.onclick=()=>{ listPage=i; renderSongsPage(); };
      pagination.appendChild(b);
    }
  }

  function buildRanking(){
    return [...allSongs]
      .sort((a,b)=>Number(b["æ’­æ”¾æ¬¡æ•¸"]||0)-Number(a["æ’­æ”¾æ¬¡æ•¸"]||0))
      .slice(0,40);
  }

  function renderRankingPage(){
    const rankData=buildRanking();
    const totalPages=Math.max(1, Math.ceil(rankData.length/pageSize));
    if(rankPage>totalPages) rankPage=1;

    const start=(rankPage-1)*pageSize;
    const pageData=rankData.slice(start, start+pageSize);

    rankList.innerHTML="";
    pageData.forEach((song,idx)=>{
      const card=document.createElement("div");
      card.className="song-card";
      const rankNo=start+idx+1;
      const star = (song["æ˜Ÿè™Ÿ"]==="â˜…") ? `<span class="star">â˜…</span>` : "";
      const plays = Number(song["æ’­æ”¾æ¬¡æ•¸"]||0);

      card.innerHTML=`
        <div class="song-left">
          <div class="song-name">#${rankNo} ${esc(song["æ­Œå"]||"")} - ${esc(song["æ­Œæ‰‹"]||"")} ${star}</div>
          <div class="song-meta">åˆ†é¡ï¼š${song.sheetName} ï½œ æ’­æ”¾æ¬¡æ•¸ï¼š${plays}</div>
        </div>
        <div>
          ${token ? `<button class="btn" onclick="addClick('${song.sheetName}',${song.rowIndex})">+1</button>`:""}
        </div>
      `;
      rankList.appendChild(card);
    });

    rankPagination.innerHTML="";
    for(let i=1;i<=totalPages;i++){
      const b=document.createElement("button");
      b.className="btn gray";
      b.textContent=i;
      b.onclick=()=>{ rankPage=i; renderRankingPage(); };
      rankPagination.appendChild(b);
    }
  }

  function addClick(sheetName,rowIndex){
    postJSON({ action:"addClick", token, sheetName, rowIndex })
    .then(res=>{
      if(res.status==="updated"){
        const el=document.getElementById(`plays-${sheetName}-${rowIndex}`);
        if(el) el.textContent = String(Number(el.textContent||0)+1);

        const item=allSongs.find(s=>s.sheetName===sheetName && s.rowIndex===rowIndex);
        if(item) item["æ’­æ”¾æ¬¡æ•¸"]=Number(item["æ’­æ”¾æ¬¡æ•¸"]||0)+1;

        renderRankingPage();
      }else{
        alert("ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥");
        logout();
      }
    })
    .catch(()=>alert("+1 å¤±æ•—"));
  }

  // ===== æ–°å¢æ­Œæ›²ï¼šæ”¹æˆ toolbar çš„ã€Œæ–°å¢æ­Œæ›²ã€æŒ‰éˆ• =====
  function openAdminAddSong(){
    if(!token){
      alert("è«‹å…ˆç®¡ç†è€…ç™»å…¥");
      return;
    }
    // reset
    mSheet.value = "å¥³æ­Œæ‰‹";
    onSheetChange();
    mSongName.value = "";
    mSinger.value = "";
    mPlays.value = 0;
    starSelected = false;
    refreshStarBtn();
    modalOverlay.style.display="flex";
  }

  function closeAddSong(){ modalOverlay.style.display="none"; }

  function onSheetChange(){
    const isOther = (mSheet.value === "å…¶ä»–");
    document.getElementById("subtagSelectField").style.display = isOther ? "block" : "none";
  }

  function toggleStar(){
    starSelected = !starSelected;
    refreshStarBtn();
  }
  function refreshStarBtn(){
    const btn=document.getElementById("starToggleBtn");
    if(starSelected){
      btn.textContent="â˜… å·²æ¨™è¨˜";
      btn.className="btn";
    }else{
      btn.textContent="â˜† æœªæ¨™è¨˜";
      btn.className="btn gray";
    }
  }

  async function submitAdminAddSong(){
    const sheetName = mSheet.value;
    const songName = mSongName.value.trim();
    const singer = mSinger.value.trim();
    const plays = Number(mPlays.value||0);

    if(!songName || !singer){
      alert("è«‹è‡³å°‘å¡«ï¼šæ­Œåã€æ­Œæ‰‹");
      return;
    }

    const subtag = (sheetName === "å…¶ä»–") ? (mSubtagSelect.value || "") : "";

    postJSON({
      action:"addSong",
      token,
      sheetName,
      songName,
      singer,
      star: starSelected,
      plays,
      subtag
    })
    .then(async res=>{
      if(res.status==="added"){
        closeAddSong();
        await loadAllSongs();
        renderSongsPage();
        renderRankingPage();
        alert("æ–°å¢æˆåŠŸï¼Œå·²å›å¯«è©¦ç®—è¡¨");
      }else if(res.status==="unauthorized"){
        alert("ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥");
        logout();
      }else{
        alert("æ–°å¢å¤±æ•—ï¼š"+(res.status||"unknown"));
      }
    })
    .catch(()=>alert("æ–°å¢å¤±æ•—"));
  }

  function esc(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
</script>

</body>
</html>

